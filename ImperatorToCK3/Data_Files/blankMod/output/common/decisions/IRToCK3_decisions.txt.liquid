{% if vanilla or roa or aep %}
## Form Silla/Baekje/Goguryeo Kingdoms
irtock3_formalize_korean_kingdom_decision = {
	picture = {
		reference = "gfx/interface/illustrations/activity_splash_screens/tour_arrival_asia_welcome.dds"
	}
	decision_group_type = major

	ai_check_interval_by_tier = {
		barony = 0
		county = 0
		duchy = 36
		kingdom = 48
		empire = 0
		hegemony = 0
	}
	
	widget = {
		gui = "decision_view_widget_option_list_generic"
		controller = decision_option_list_controller
		decision_to_second_step_button = "irtock3_formalize_korean_kingdom_decision"
		show_from_start = yes

		item = {
			value = irtock3_form_baekje
			localization = irtock3_form_baekje_kingdom
			is_valid = {
				custom_tooltip = {
					text = irtock3_korean_kingdom_not_formed
					NOT = {
						is_target_in_global_variable_list = {
							name = unavailable_unique_decisions
							target = flag:irtock3_form_korean_kingdom_baekje
						}
					}
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_is_titular
					title:k_baekje = { is_titular = yes }
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_baekje_culture
					culture = {
						OR = {
							this = culture:baekje
							any_parent_culture_or_above = { this = culture:baekje }
						}
					}
				}
			}
			ai_chance = { value = 100 }
		}

		item = {
			value = irtock3_form_goguryeo
			localization = irtock3_form_goguryeo_kingdom
			is_valid = {
				custom_tooltip = {
					text = irtock3_korean_kingdom_not_formed
					NOT = {
						is_target_in_global_variable_list = {
							name = unavailable_unique_decisions
							target = flag:irtock3_form_korean_kingdom_goguryeo
						}
					}
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_is_titular
					title:k_goguryeo = { is_titular = yes }
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_goguryeo_culture
					culture = {
						OR = {
							this = culture:goguryeo
							any_parent_culture_or_above = { this = culture:goguryeo }
						}
					}
				}
			}
			ai_chance = { value = 100 }
		}

		item = {
			value = irtock3_form_silla
			localization = irtock3_form_silla_kingdom
			is_valid = {
				custom_tooltip = {
					text = irtock3_korean_kingdom_not_formed
					NOT = {
						is_target_in_global_variable_list = {
							name = unavailable_unique_decisions
							target = flag:irtock3_form_korean_kingdom_silla
						}
					}
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_is_titular
					title:k_silla = { is_titular = yes }
				}
				custom_tooltip = {
					text = irtock3_korean_kingdom_silla_culture
					culture = {
						OR = {
							this = culture:silla
							any_parent_culture_or_above = { this = culture:silla }
						}
					}
				}
			}
			ai_chance = { value = 100 }
		}
	}

	is_shown = {
		# Can't already have on of these titles
		NOR = {
			has_title = title:k_silla
			has_title = title:k_baekje
			has_title = title:k_goguryeo
		}
		# Need to have a relevant culture
		culture = {
			OR = {
				has_cultural_pillar = heritage_korean
				has_cultural_pillar = heritage_buyeo
				any_parent_culture = {
					OR = {
						has_cultural_pillar = heritage_korean
						has_cultural_pillar = heritage_buyeo
					}
				}
			}
		}
		# Only Dukes or Kings
		OR = {
			highest_held_title_tier = tier_duchy
			highest_held_title_tier = tier_kingdom
		}
		# This decision can only be taken once for each of the base game kingdoms, so need to check there is at least one of the kingdoms this hasn't been taken for yet
		NAND = {
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_silla
			}
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_baekje
			}
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_goguryeo
			}
		}
	}

	is_valid = {
		# Only Dukes or Kings
		OR = {
			highest_held_title_tier = tier_duchy
			highest_held_title_tier = tier_kingdom
		}
		top_liege = this # Independent
		# Need to control a certain amount of Korea
		custom_tooltip = {
			text = irtock3_control_korean_counties
			any_county_in_region = {
				region = world_asia_korea
				count >= 12
				holder.top_liege ?= root
			}
		}
	}

	is_valid_showing_failures_only = {
		is_available_adult = yes
		is_at_war = no
	}

	cost = {
		gold = {
			value = 300
			if = {
				limit = {
					OR = {
						government_has_flag = government_is_nomadic
						has_treasury = yes
					}
				}
				multiply = 0
			}
		}
		treasury = {
			value = 300
			if = {
				limit = {
					has_treasury = no
				}
				multiply = 0
			}
		}
		prestige = 500
		piety = {
			value = 200
			if = {
				limit = {
					government_has_flag = government_is_nomadic
				}
				multiply = 0
			}
		}
	}

	effect = {
		# Save title in new scope to condense code, and indicate that the relevant kingdom has been formed through this decision, so it can't be formed from now on
		if = {
			limit = { scope:irtock3_form_baekje = yes }
			title:k_baekje = { save_scope_as = new_title }
			add_to_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_baekje
			}
		}
		else_if = {
			limit = { scope:irtock3_form_goguryeo = yes }
			title:k_goguryeo = { save_scope_as = new_title }
			add_to_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_goguryeo
			}
		}
		else_if = {
			limit = { scope:irtock3_form_silla = yes }
			title:k_silla = { save_scope_as = new_title }
			add_to_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:irtock3_form_korean_kingdom_silla
			}
		}

		# Setup new title (similar to setup of new custom kingdom)
		custom_tooltip = irtock3_new_korean_kingdom
		if = {
			limit = { highest_held_title_tier >= tier_kingdom }
			custom_tooltip = irtock3_merge_korean_kingdom
		}
		hidden_effect = {
			save_scope_as = founder
			
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
				add_claim_on_loss = no
			}
			
			scope:new_title = {
				change_title_holder = {
					holder = root
					change = scope:change
				}
			}
			
			resolve_title_and_vassal_change = scope:change

			#Check if all territory is from a single Empire, and if so, make Kingdom de jure of that Empire
			every_sub_realm_county = {
				if = {
					limit = { exists = empire }
					empire = {
						if = {
							limit = {
								NOT = { is_in_list = potential_empires }
							}
							add_to_list = potential_empires
						}
					}
				}
			}
			if = {
				limit = {
					any_in_list = {
						list = potential_empires
						count > 0
					}
				}
				ordered_in_list = {
					list = potential_empires
					order_by = {
						every_in_de_jure_hierarchy = {
							continue = { tier > tier_county }
							limit = {
								tier = tier_county
								holder.top_liege = root
							}
							add = 1
						}
					}
					position = 0
					save_scope_as = old_empire
				}
			}
			if = {
				limit = { exists = scope:old_empire }
				scope:new_title = { set_de_jure_liege_title = scope:old_empire }
			}
			
			every_held_title = {
				limit = {
					OR = {
						tier = tier_duchy
						tier = tier_kingdom
					}
					NOT = { this = scope:new_title }
				}

				if = {
					limit = { tier = tier_duchy }

					if = {
						limit = {
							#Check if you need to notify a player
							OR = {
								AND = {
									kingdom ?= {
										holder ?= {
											this != root
											is_ai = no
										}
									}
								}
								AND = {
									empire ?= {
										holder ?= {
											this != root
											is_ai = no
										}
									}
								}
							}
						}
						add_to_temporary_list = duchy_for_notification
						root = {
							save_temporary_scope_value_as = {
								name = send_notifications
								value = yes
							}
						}
					}
					set_de_jure_liege_title = scope:new_title
				}
				else_if = {
					limit = {
						tier = tier_kingdom
						is_figurehead_title = no
						is_head_of_faith = no
					}

					if = {
						limit = {
							any_in_de_jure_hierarchy = { tier = tier_duchy }
						}

						every_in_de_jure_hierarchy = {
							limit = { tier = tier_duchy }
							set_de_jure_liege_title = scope:new_title
						}
					}

					root = { destroy_title = prev }
				}
			}

			every_sub_realm_county = {
				limit = {
					exists = duchy
					NOT = { exists = duchy.holder }
					holder.top_liege = root
					duchy = { save_temporary_scope_as = test_duchy }
					holder.top_liege = { completely_controls = scope:test_duchy }
				}
				if = {
					limit = {
						NOT = {
							duchy = { is_in_list = additional_de_jure_duchies }
						}
					}
					duchy = {
						set_de_jure_liege_title = scope:new_title
						add_to_list = additional_de_jure_duchies
					}
				}
			}
			
			set_primary_title_to = scope:new_title
			
			trigger_event = major_decisions.1101
			
			every_player = {
				if = {
					limit = {
						top_liege = scope:founder
						this != root
					}
					trigger_event = major_decisions.1102
				}
				else_if = {
					limit = {
						exists = scope:send_notifications
						this != root
						top_liege != scope:founder
						any_held_title = {
							any_in_de_jure_hierarchy = {
								continue = {
									tier > tier_duchy
								}
								tier = tier_duchy
								is_in_list = duchy_for_notification
							}
						}
					}
					every_held_title = {
						every_in_de_jure_hierarchy = {
							continue = {
								tier > tier_duchy
							}
							limit = {
								tier = tier_duchy
								is_in_list = duchy_for_notification
							}
							add_to_list = notification_titles	
						}
					}			
					if = {
						limit = {
							any_in_list = {
								list = notification_titles
								count > 0
							}
						}
						trigger_event = major_decisions.1105
					}
				}
			}
		}
	}

	ai_potential = {
		# Need to have a relevant culture
		culture = {
			OR = {
				has_cultural_pillar = heritage_korean
				has_cultural_pillar = heritage_buyeo
				any_parent_culture = {
					OR = {
						has_cultural_pillar = heritage_korean
						has_cultural_pillar = heritage_buyeo
					}
				}
			}
		}
		# Only Dukes or Kings
		OR = {
			highest_held_title_tier = tier_duchy
			highest_held_title_tier = tier_kingdom
		}
	}

	ai_will_do = {
		base = 100
	}
}
{% endif %}